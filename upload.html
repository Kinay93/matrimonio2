<input type="file" id="fileInput" multiple>
<button class="btn" onclick="uploadFiles()">Carica</button>
<div id="progressContainer"></div>

<script>
function uploadFiles() {
  const input = document.getElementById('fileInput');
  const container = document.getElementById('progressContainer');
  container.innerHTML = ""; // pulisce le barre precedenti

  const files = input.files;
  if (files.length === 0) {
    alert("Seleziona almeno una foto.");
    return;
  }

  // crea le barre di progresso
  const progressElements = [];
  for (const file of files) {
    const wrapper = document.createElement("div");
    wrapper.className = "progressWrapper";

    const label = document.createElement("div");
    label.className = "progressLabel";
    label.textContent = "Caricamento: " + file.name;

    const bar = document.createElement("div");
    bar.className = "progressBar";

    const progress = document.createElement("div");
    bar.appendChild(progress);

    wrapper.appendChild(label);
    wrapper.appendChild(bar);
    container.appendChild(wrapper);

    progressElements.push({file, progress, label});
  }

  // invio tutti i file in un unico POST
  const formData = new FormData();
  for (const f of files) {
    formData.append("foto", f); // tutti i file con campo "foto"
  }

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "https://matrimoniome.appspot.com/upload", true);

  xhr.upload.addEventListener("progress", (e) => {
    if (e.lengthComputable) {
      const percent = (e.loaded / e.total) * 100;
      // aggiorna tutte le barre in proporzione
      progressElements.forEach(pe => pe.progress.style.width = percent + "%");
    }
  });

  xhr.onload = () => {
    if (xhr.status === 200) {
      const response = JSON.parse(xhr.responseText);
      response.files.forEach(f => {
        const pe = progressElements.find(p => p.file.name === f.filename);
        if (pe) pe.label.textContent = "✅ Caricato: " + f.filename;
      });
    } else {
      progressElements.forEach(pe => pe.label.textContent = "❌ Errore: " + pe.file.name);
    }
  };

  xhr.onerror = () => {
    progressElements.forEach(pe => pe.label.textContent = "❌ Errore connessione: " + pe.file.name);
  };

  xhr.send(formData);
}
</script>
