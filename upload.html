<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carica le tue foto e video</title>
<style>
  body { background-color: #F7EAEC; font-family: "Dancing Script", cursive; text-align: center; padding:20px;}
  h1 { color:#FF4CAA; font-size:36px; margin-bottom:30px; }
  #fileInput { display:none; }
  .btn { background:#FF4CAA; color:white; border:none; padding:12px 30px; border-radius:50px; cursor:pointer; margin:10px;}
  .btn:hover { background:#d43d8b; }
  #preview { display:flex; flex-wrap:wrap; justify-content:center; gap:15px; margin-top:20px; }
  .preview-wrapper { display:flex; flex-direction:column; align-items:center; }
  .preview-img { width:150px; height:150px; object-fit:cover; border-radius:15px; border:2px solid #FF4CAA; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
  .remove-btn { margin-top:5px; background:#FF4CAA; border:none; color:white; padding:5px 12px; border-radius:20px; cursor:pointer; font-size:12px;}
  .remove-btn:hover { background:#d43d8b; }
  #progressContainer { margin-top:20px; width:90%; max-width:600px; margin:auto; }
  .progressWrapper { margin-bottom:15px; text-align:left; }
  .progressLabel { font-size:14px; color:#FF4CAA; margin-bottom:5px; }
  .progressBar { width:100%; height:14px; background:#eee; border-radius:10px; overflow:hidden; }
  .progressBar div { height:100%; width:0; background:linear-gradient(90deg,#FF4CAA,#FF85D0); transition:width 0.3s ease; }
</style>
</head>
<body>

<h1>Carica le tue foto e video</h1>
<label class="btn" for="fileInput">Seleziona File</label>
<input type="file" id="fileInput" multiple accept="image/*,video/*">
<button class="btn" onclick="uploadFiles()">Carica</button>

<div id="preview"></div>
<div id="progressContainer"></div>

<a href="gallery.html" class="btn">Galleria</a>

<script>
const fileInput = document.getElementById('fileInput');
const previewContainer = document.getElementById('preview');
let selectedFiles = [];

fileInput.addEventListener('change', () => {
  selectedFiles = Array.from(fileInput.files);
  renderPreview();
});

function renderPreview() {
  previewContainer.innerHTML = '';
  selectedFiles.forEach((file,index)=>{
    const wrapper = document.createElement('div');
    wrapper.className='preview-wrapper';
    if(file.type.startsWith("video/")){
      const vid = document.createElement("video");
      vid.src = URL.createObjectURL(file);
      vid.controls = true;
      vid.className = 'preview-img';
      vid.style.objectFit = "cover";
      wrapper.appendChild(vid);
    } else {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'preview-img';
        wrapper.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Rimuovi';
    removeBtn.className = 'remove-btn';
    removeBtn.onclick = () => { selectedFiles.splice(index,1); renderPreview(); };
    wrapper.appendChild(removeBtn);
    previewContainer.appendChild(wrapper);
  });
}

async function uploadFiles() {
  if(selectedFiles.length === 0){ alert("Seleziona almeno un file."); return; }
  const container = document.getElementById('progressContainer');
  container.innerHTML = "";

  for(const file of selectedFiles){
    const wrapper = document.createElement("div");
    wrapper.className = "progressWrapper";
    const label = document.createElement("div");
    label.className = "progressLabel";
    label.textContent = "Caricamento: " + file.name;
    const bar = document.createElement("div");
    bar.className = "progressBar";
    const progress = document.createElement("div");
    bar.appendChild(progress);
    wrapper.appendChild(label);
    wrapper.appendChild(bar);
    container.appendChild(wrapper);

    try{
      if(file.type.startsWith("image/")){
        // Foto -> upload diretto su backend
        const formData = new FormData();
        formData.append("foto", file);
        const res = await fetch("https://matrimoniome-backend-963503805745.europe-west1.run.app/upload", {method:"POST", body:formData});
        const data = await res.json();
        label.textContent = "✅ Caricato: " + file.name;
        progress.style.width = "100%";
      } else {
        // Video -> upload con signed URL
        const res = await fetch("https://matrimoniome-backend-963503805745.europe-west1.run.app/generate_upload_url",{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({filename:file.name, contentType:file.type})
        });
        const {uploadUrl, publicUrl} = await res.json();

        await uploadLargeFile(file, uploadUrl, progress);

        // Rende il video pubblico e recupera l'URL definitivo
        const pubRes = await fetch("https://matrimoniome-backend-963503805745.europe-west1.run.app/make_public", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({blob_name: `uploads/${file.name}`})
        });
        const pubData = await pubRes.json();
        const finalUrl = pubData.public_url || publicUrl;

        label.innerHTML = `✅ Caricato: <a href="${finalUrl}" target="_blank">${file.name}</a>`;
        progress.style.width = "100%";
      }
    } catch(err){
      console.error(err);
      label.textContent = "❌ Errore: " + file.name;
    }
  }
}

async function uploadLargeFile(file, uploadUrl, progressElement){
  const chunkSize = 10 * 1024 * 1024; // 10 MB
  let offset = 0;

  while(offset < file.size){
    const chunk = file.slice(offset, offset + chunkSize);
    await fetch(uploadUrl, {
      method: "PUT",
      headers: {
        "Content-Range": `bytes ${offset}-${offset + chunk.size - 1}/${file.size}`,
        "Content-Type": file.type
      },
      body: chunk
    });
    offset += chunkSize;
    progressElement.style.width = (offset / file.size * 100) + "%";
  }
}
</script>
</body>
</html>
