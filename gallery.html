<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Galleria Matrimonio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background-color: #F7EAEC;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 20px;
  }
  h1 { color: #FF4CAA; margin-bottom: 20px; }
  .filters { margin-bottom: 20px; }
  .filters button {
    background: #FF4CAA; color: white; border:none; padding:8px 16px; margin:5px; border-radius:8px; cursor:pointer;
  }
  .filters button.active { background:#d43d8b; }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    width: 100%;
    max-width: 1200px;
  }
  .grid-item {
    width: 100%;
    aspect-ratio: 1/1;
    overflow: hidden;
    border-radius: 8px;
    border: 2px solid #ccc;
    position: relative;
    cursor: pointer;
    background: #eee;
  }
  .grid-item img, .grid-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  #modal {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #modalContent img, #modalContent video {
    max-width: 95vw;
    max-height: 90vh;
    border-radius: 5px;
  }
  #close {
    position: absolute;
    top: 20px; right: 20px;
    color: white; font-size: 30px; cursor: pointer;
  }
  .btn { background: black; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; margin: 10px; }
  .arrow { position: absolute; top: 50%; transform: translateY(-50%); font-size: 40px; color: white; cursor: pointer; user-select: none; padding: 10px; }
  #prev { left: 20px; }
  #next { right: 20px; }
</style>
</head>
<body>

<h1>Galleria Foto & Video</h1>

<div class="filters">
  <button class="active" data-type="photo">Foto</button>
  <button data-type="video">Video</button>
</div>

<div class="grid" id="photoGrid"></div>

<a class="btn" id="uploadBtn">Carica Foto/Video</a>
<a class="btn" id="homeBtn">Home</a>

<div id="modal">
  <span id="close">&times;</span>
  <span id="prev" class="arrow">&#10094;</span>
  <div id="modalContent"></div>
  <span id="next" class="arrow">&#10095;</span>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const coppia = params.get("coppia") || "default";
document.getElementById("uploadBtn").href = `upload.html?coppia=${coppia}`;
document.getElementById("homeBtn").href = `index.html?coppia=${coppia}`;

let gallery = [];
let filteredGallery = [];
let currentIndex = 0;
let currentFilter = "photo";

// ðŸ”— Endpoint Cloud Run
const ENDPOINT = `https://matrimoniome-backend-963503805745.europe-west1.run.app/gallery?coppia=${coppia}`;

// Fetch galleria
fetch(ENDPOINT)
  .then(res => res.json())
  .then(data => {
    gallery = data;
    // CompatibilitÃ  vecchio formato e thumbnail video
    gallery = gallery.map(f => ({
      ...f,
      type: f.type || (f.url.endsWith(".mp4") ? "video" : "photo"),
      thumbUrl: f.thumbUrl || (f.url.endsWith(".mp4") ? `https://storage.googleapis.com/matrimonio_bucket/thumbnails/${f.name}.jpg` : f.url)
    }));
    filteredGallery = gallery.filter(f => f.type === "photo");
    renderGrid();
    initLazyLoad();
  })
  .catch(err => {
    console.error("Errore nel caricamento galleria:", err);
    alert("Impossibile caricare la galleria ðŸ˜¢");
  });

// Filtri
document.querySelectorAll(".filters button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".filters button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentFilter = btn.dataset.type;
    filteredGallery = gallery.filter(f => f.type === currentFilter);
    renderGrid();
    initLazyLoad();
  };
});

// Creazione griglia
function createGridItem(file, index) {
  const wrapper = document.createElement('div');
  wrapper.className = "grid-item";
  wrapper.dataset.index = index;

  const img = document.createElement('img');
  img.src = file.thumbUrl || file.url; // usa thumbUrl per video
  wrapper.appendChild(img);

  wrapper.onclick = () => openModal(index); // sia foto che video aprono il modal

  return wrapper;
}

// Render griglia
function renderGrid() {
  const grid = document.getElementById('photoGrid');
  grid.innerHTML = '';
  filteredGallery.forEach((file, index) => {
    const item = createGridItem(file, index);
    grid.appendChild(item);
  });
}

// Modal per foto/video
function openModal(index) {
  currentIndex = index;
  showMedia();
  document.getElementById('modal').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.getElementById('modalContent').innerHTML = '';
}
function showMedia() {
  const modalContent = document.getElementById('modalContent');
  modalContent.innerHTML = '';
  const file = filteredGallery[currentIndex];

  if (file.type === "video") {
    const vid = document.createElement('video');
    vid.src = file.url;
    vid.controls = true;
    vid.autoplay = true;
    modalContent.appendChild(vid);
  } else {
    const img = document.createElement('img');
    img.src = file.url;
    modalContent.appendChild(img);
  }

  preloadNeighbors();
}

// Preload successivo/precedente
function preloadNeighbors() {
  const nextIndex = (currentIndex + 1) % filteredGallery.length;
  const prevIndex = (currentIndex - 1 + filteredGallery.length) % filteredGallery.length;
  [nextIndex, prevIndex].forEach(i => {
    const file = filteredGallery[i];
    if (file.type === "video") {
      const vid = document.createElement('video');
      vid.src = file.url;
      vid.preload = "metadata";
    } else {
      const img = new Image();
      img.src = file.url;
    }
  });
}

// Navigazione
document.getElementById("next").onclick = nextMedia;
document.getElementById("prev").onclick = prevMedia;
document.getElementById("close").onclick = closeModal;

function nextMedia() {
  currentIndex = (currentIndex + 1) % filteredGallery.length;
  showMedia();
}
function prevMedia() {
  currentIndex = (currentIndex - 1 + filteredGallery.length) % filteredGallery.length;
  showMedia();
}

// Tastiera e swipe
document.addEventListener("keydown", (e) => {
  if (document.getElementById('modal').style.display === 'flex') {
    if (e.key === "ArrowRight") nextMedia();
    if (e.key === "ArrowLeft") prevMedia();
    if (e.key === "Escape") closeModal();
  }
});
let startX = 0;
document.getElementById('modal').addEventListener("touchstart", e => startX = e.touches[0].clientX);
document.getElementById('modal').addEventListener("touchend", e => {
  let endX = e.changedTouches[0].clientX;
  if (endX - startX > 50) prevMedia();
  if (startX - endX > 50) nextMedia();
});
document.getElementById('modal').addEventListener("click", e => {
  if (e.target.id === 'modal') closeModal();
});

// Lazy load
function initLazyLoad() {
  const images = document.querySelectorAll('.grid img');
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) observer.unobserve(entry.target);
    });
  }, { rootMargin: "200px" });
  images.forEach(img => observer.observe(img));
}
</script>
</body>
</html>
