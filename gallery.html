<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Galleria Matrimonio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    background-color: #F7EAEC;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 20px;
  }
  h1 { color: #FF4CAA; margin-bottom: 20px; }
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
    width: 100%;
    max-width: 1200px;
  }
  .grid img, .grid video {
    width: 100%;
    cursor: pointer;
    border: 2px solid #ccc;
    border-radius: 8px;
    object-fit: cover;
  }
  #modal {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #modalContent img, #modalContent video {
    max-width: 95vw;
    max-height: 90vh;
    border-radius: 5px;
  }
  #close {
    position: absolute;
    top: 20px; right: 20px;
    color: white; font-size: 30px; cursor: pointer;
  }
  .btn {
    background: black; color: white; padding: 10px 20px;
    border-radius: 8px; text-decoration: none; margin: 10px;
  }
  .arrow {
    position: absolute; top: 50%; transform: translateY(-50%);
    font-size: 40px; color: white; cursor: pointer; user-select: none; padding: 10px;
  }
  #prev { left: 20px; }
  #next { right: 20px; }
</style>
</head>
<body>

<h1>Galleria Foto & Video</h1>
<div class="grid" id="photoGrid"></div>

<a class="btn" id="uploadBtn">Carica Foto/Video</a>
<a class="btn" id="homeBtn">Home</a>

<div id="modal">
  <span id="close">&times;</span>
  <span id="prev" class="arrow">&#10094;</span>
  <div id="modalContent"></div>
  <span id="next" class="arrow">&#10095;</span>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const coppia = params.get("coppia") || "default";

document.getElementById("uploadBtn").href = `upload.html?coppia=${coppia}`;
document.getElementById("homeBtn").href = `index.html?coppia=${coppia}`;

let gallery = [];
let currentIndex = 0;

// --- Lazy load dei thumbnail ---
function createGridItem(file, index){
  const ext = file.name.split('.').pop().toLowerCase();
  const wrapper = document.createElement('div');

  if(["mp4","webm","ogg"].includes(ext)){
    const vid = document.createElement('video');
    vid.poster = file.thumbUrl || "";
    vid.dataset.src = file.url;
    vid.muted = true; vid.loop = true; vid.playsInline = true;
    vid.preload = "none";
    vid.onclick = () => openModal(index);
    wrapper.appendChild(vid);
  } else {
    const img = document.createElement('img');
    img.dataset.src = file.thumbUrl || file.url;
    img.loading = "lazy";
    img.alt = file.name;
    img.onclick = () => openModal(index);
    wrapper.appendChild(img);
  }
  return wrapper;
}

// --- Fetch galleria ---
fetch(`https://matrimoniome.appspot.com/gallery?coppia=${coppia}`)
  .then(res => res.json())
  .then(data => {
    gallery = data;
    const grid = document.getElementById('photoGrid');
    gallery.forEach((file,index)=>{
      const item = createGridItem(file,index);
      grid.appendChild(item);
    });
    initLazyLoad();
  });

// --- Modal ---
function openModal(index){
  currentIndex = index;
  showMedia();
  document.getElementById('modal').style.display='flex';
}
function closeModal(){
  document.getElementById('modal').style.display='none';
  document.getElementById('modalContent').innerHTML='';
}
function showMedia(){
  const modalContent = document.getElementById('modalContent');
  modalContent.innerHTML='';
  const file = gallery[currentIndex];
  const ext = file.name.split('.').pop().toLowerCase();

  if(["mp4","webm","ogg"].includes(ext)){
    const vid = document.createElement('video');
    vid.src = file.url; vid.controls=true; vid.autoplay=true;
    modalContent.appendChild(vid);
  } else {
    const img = document.createElement('img');
    img.src = file.url;
    modalContent.appendChild(img);
  }
  preloadNeighbors();
}

// --- Preload successivo e precedente ---
function preloadNeighbors(){
  const nextIndex = (currentIndex+1)%gallery.length;
  const prevIndex = (currentIndex-1+gallery.length)%gallery.length;
  [nextIndex,prevIndex].forEach(i=>{
    const file = gallery[i];
    const ext = file.name.split('.').pop().toLowerCase();
    if(["mp4","webm","ogg"].includes(ext)){
      const vid=document.createElement('video'); vid.src=file.url; vid.preload="metadata";
    } else {
      const img=new Image(); img.src=file.url;
    }
  });
}

// --- Frecce tastiera ---
document.addEventListener("keydown",(e)=>{
  if(document.getElementById('modal').style.display==='flex'){
    if(e.key==="ArrowRight") nextMedia();
    if(e.key==="ArrowLeft") prevMedia();
    if(e.key==="Escape") closeModal();
  }
});
document.getElementById("next").onclick = nextMedia;
document.getElementById("prev").onclick = prevMedia;
document.getElementById("close").onclick = closeModal;
function nextMedia(){ currentIndex=(currentIndex+1)%gallery.length; showMedia(); }
function prevMedia(){ currentIndex=(currentIndex-1+gallery.length)%gallery.length; showMedia(); }

// --- Swipe mobile ---
let startX = 0;
document.getElementById('modal').addEventListener("touchstart",(e)=>{ startX=e.touches[0].clientX; });
document.getElementById('modal').addEventListener("touchend",(e)=>{
  let endX=e.changedTouches[0].clientX;
  if(endX-startX>50) prevMedia();
  if(startX-endX>50) nextMedia();
});
document.getElementById('modal').addEventListener("click",(e)=>{
  if(e.target.id==='modal') closeModal();
});

// --- Lazy load immagini e video ---
function initLazyLoad(){
  const images = document.querySelectorAll('.grid img');
  const videos = document.querySelectorAll('.grid video');
  const observer = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting){
        const el = entry.target;
        if(el.tagName==="IMG") el.src=el.dataset.src;
        if(el.tagName==="VIDEO") el.src=el.dataset.src;
        observer.unobserve(el);
      }
    });
  }, {rootMargin:"200px"});
  images.forEach(img=>observer.observe(img));
  videos.forEach(vid=>observer.observe(vid));
}
</script>
</body>
</html>
